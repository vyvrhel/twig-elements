{#-
	**********
	Source tag
	**********

	An extendable HTML skeleton for a single <source> element inside a <picture> block.
	Supports automatic srcset generation, MIME type detection, and selective HTML attribute rendering.

	HTML attributes:
	----------------
	All attributes of the <source> tag are assigned via properties of the `source` object.
	For example, `source.srcset`, `source.type`, `source.media`, etc.

	Properties:
	-----------
	└── Source handling:
	- "srcset" (string|array) - Srcset definitions. Can be specified in two forms:
		- Plain string: `"photo@2x.jpg 2x, photo@3x.jpg 3x"`
		- Array of objects with descriptor keys: `{ "": { "photo.jpg" }, "2x": { "photo@2x.jpg" }, "3x": { "photo@3x.jpg" } }`
	- "auto_descriptors" (array) - List of descriptors (e.g. "2x", "480w") for automatic srcset generation.
		When defined and `source.srcset` is missing, descriptors will be appended to the base filename.
	- "media" (string) - Media query for the source element.
	- "type" (string) - MIME type of the image. If not provided, automatically derived from the file extension via "types" mapping.

	└── HTML attribute handling:
	- "html_attrs" (array) - Whitelisted HTML attributes to render.
	- Attribute rendering rules:
		- attr = value → renders `attr="value"`.
		- attr = true → renders `attr`.
		- attr = false|null → not rendered.
		- prefixed with "!" → concatenates instead of overriding.

	└── MIME type mapping:
	- "types" (object) - Maps extensions to MIME types.
	- Fallback: 'image/<extension>' if no mapping exists.

	Example:
	--------

		Twig:
		-----
		{% set source = {
			'srcset': { '': 'image_600.jpg' },
			'width': 600,
			'height': 900,
			'media': '(max-width: 600px)',
			'auto_descriptors': ['2x', '3x'],
		}|merge(source ?? {}) %}

		HTML result:
		------------
		<source
			srcset="image_600.jpg, image_600@2x.jpg 2x, image_600@3x.jpg 3x"
			width="600"
			height="900"
			media="(max-width: 600px)"
			type="image/jpeg"
		>
-#}

{%- set source = {
	'auto_descriptors': [],

	'html_attrs': ['id', 'src', 'srcset', 'sizes', 'class', 'title', 'is', 'width', 'height',
		'data-.+', 'style', 'tabindex', 'hidden', 'media', 'type'],

	'types': { 'jpg': 'image/jpeg', 'jpe': 'image/jpeg', 'svg': 'image/svg+xml', 'ico': 'image/x-icon', 'tif': 'image/tiff' },
}|merge(source ?? {}) -%}

{#- Wrap -#}
{%- block source_scope -%}

	{#- = Srcset autocompletion -#}
	{%- if (source.srcset ?? null) is iterable and source.srcset|length == 1 -%}
		{%- for d in source.auto_descriptors -%}
			{%- set _src_parts = source.srcset|first|split('.') -%}
			{%- set source = source|merge({
				'srcset': source.srcset|merge({ (d): _src_parts[:-1]|join('.') ~ '@' ~ d ~ '.' ~ _src_parts|last })
			}) -%}
		{%- endfor -%}
	{%- endif -%}

	{#- = Type autocompletion -#}
	{%- if not (source.type ?? null) -%}

		{#- = Image extension -#}
		{%- set _img_format = (source.srcset ?? null)|length
			? (source.srcset is iterable ? source.srcset|first : source.srcset)|split('.')|last|split('?')|first|lower
			: null
		-%}

		{#- = Type -#}
		{%- if _img_format -%}
			{%- set source = source|merge({ 'type': source.types[_img_format] ?? ('image/' ~ _img_format) }) -%}
		{%- endif -%}

	{%- endif -%}

	{#- Source wrap -#}
	{%- block source_outer -%}
		{%- if (source.src ?? null) or (source.srcset ?? null) -%}
			<source

				{#- Attributes -#}
				{%- block source_attrs -%}

					{#- = Get and concat "prepend/append" and "normal" HTML attributes -#}
					{%- set attrs = {} -%}
					{%- for attr in source|keys|sort -%}
						{%- set val = source[attr] -%}
						{%- if
							attr matches '/^(!?' ~ source.html_attrs|join('!?|!?') ~ '!?)$/'
							and val is not same as(false)
							and val is not same as(null)
						-%}
							{%- set is_prepend = attr starts with '!' -%}
							{%- set attr = attr|trim('!') -%}
							{%- set attrs = attrs|merge({
								(attr): (val is not iterable and val is not same as(true))
									? ((is_prepend ? val) ~ ' ' ~ (attrs[attr] ?? '') ~ ' ' ~ (not is_prepend ? val))|trim
									: val,
							}) -%}
						{%- endif -%}
					{%- endfor -%}

					{#- Render attributes -#}
					{%- for attr, val in attrs -%}

						{#- = Srcset - object to string conversion -#}
						{%- if attr == 'srcset' and val is iterable -%}
							{%- set _new_val = '' -%}
							{%- for d, src in val -%}
								{%- set _new_val -%}
									{{- _new_val -}}, {% with { 'val': src } %}{{ block('source_attr_src') }}{% endwith %}{% if d %} {{ d }}{% endif -%}
								{%- endset -%}
							{%- endfor -%}
							{%- set val = _new_val|trim(',')|trim -%}
						{%- endif -%}

						{#- Attribute -#}
						{%- block source_attr -%}
							{{- ' ' ~ attr }}
							{%- if val is not same as(true) -%}
								="
								{%- autoescape 'html' -%}

									{#- Attribute value -#}
									{%- block source_attr_val -%}
										{%- if attr == 'src' -%}

											{#- Src attribute value (own block for easier src post processing) -#}
											{%- block source_attr_src val -%}

										{%- else -%}

											{#- Other attribute value -#}
											{%- block source_attr_other val -%}

										{%- endif -%}
									{%- endblock -%}

								{%- endautoescape -%}
								"
							{%- endif -%}
						{%- endblock -%}

					{%- endfor -%}
				{%- endblock -%}

			>
		{%- endif -%}
	{%- endblock -%}

{%- endblock -%}
